#!/usr/bin/env bash
set -euo pipefail

JAR_PREFIX_NAME=madek-api-v2
PROJECT_DIR="$(cd -- "$(dirname "${BASH_SOURCE}")" ; cd .. > /dev/null 2>&1 && pwd -P)"
TMP_DIR="${TMPDIR:-$PROJECT_DIR/tmp}"
mkdir -p $TMP_DIR

cd $PROJECT_DIR

function build {
  echo "Building $JAR_PREFIX_NAME.jar"
  ./bin/clean
  rm -f $JAR_PREFIX_NAME.jar
  # ./bin/clj-deps-graph
  ./bin/clj-uberjar
  ./bin/clean
}

if [[ -n $(git status -s) ]]; then
    echo "WARNING uncommitted changes, (re)building from scratch, no linking"
    build
else
    echo "OK no uncommitted changes, building or using cache"
    DIGEST=$(git log -1 HEAD --pretty=format:%T)
    CACHED_JAR="${TMP_DIR}/${JAR_PREFIX_NAME}_${DIGEST}.jar"
    if [[ -f $CACHED_JAR ]]; then
        echo "Using cached jar: $CACHED_JAR"
        touch $CACHED_JAR
    else
        echo "No cached jar found, building"
        build
        mv $JAR_PREFIX_NAME.jar $CACHED_JAR
    fi
    echo "Linking $CACHED_JAR to $JAR_PREFIX_NAME.jar"
    ln -sf $CACHED_JAR $JAR_PREFIX_NAME.jar
fi

# Clean cached jars older than a week
find $TMP_DIR -maxdepth 1 -name "${JAR_PREFIX_NAME}_*.jar" -type f -mtime +7 -delete
